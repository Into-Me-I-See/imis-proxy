<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Into-Me-I-See</title>
  <style>
    html, body { height: 100%; margin: 0; background:#000; }
    iframe { width:100%; height:100%; border:0; display:block; }
  </style>
</head>
<body>
  <iframe
    src="https://into-me-i-see-app-97c44441.base44.app"
    allow="camera; microphone; clipboard-read; clipboard-write"
  ></iframe>

  <script>
    (async () => {
      try {
        if (!('serviceWorker' in navigator)) return;
        await navigator.serviceWorker.register('/sw.js');
        await navigator.serviceWorker.ready;

        const perm = await Notification.requestPermission();
        if (perm !== 'granted') return;

        const r = await fetch('/api/public-key');
        if (!r.ok) return;
        const { vapidPublicKey } = await r.json();

        const toUint8 = (base64) => {
          const padding = '='.repeat((4 - (base64.length % 4)) % 4);
          const b64 = (base64 + padding).replace(/-/g, '+').replace(/_/g, '/');
          const raw = atob(b64);
          const out = new Uint8Array(raw.length);
          for (let i = 0; i < raw.length; i++) out[i] = raw.charCodeAt(i);
          return out;
        };

        const sub = await (await navigator.serviceWorker.ready).pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: toUint8(vapidPublicKey),
        });

        await fetch('/api/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(sub),
        });
      } catch (_) {}
    })();
  </script>
</body>
</html>
